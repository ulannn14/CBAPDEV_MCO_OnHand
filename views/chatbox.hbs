<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Messages | OnHand</title>

  <link rel="stylesheet" href="/css/chatbox.css">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet" href="/css/popups.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  {{#if (eq user.type 'provider')}}
    <script>window.APP_ROLE = 'provider';</script>
  {{else}}
    <script>window.APP_ROLE = 'customer';</script>
  {{/if}}

  <script>window.APP_USER_ID = '{{user._id}}';</script>

  <script src="/js/messages.js" defer></script>
  <script src="/js/popup.js" defer></script>
  <script src="/js/dropdown-profile.js" defer></script>
  <link rel="icon" href="/images/icon.png" type="image/png">
</head>


<body>
  {{> header}}

  <!-- views/chatbox.hbs -->
  <main class="messages-page">
    <aside class="conversations-col">
      {{!-- Render conversation list dynamically from server --}}
      <div id="convoList">
        {{#each conversations}}
          <div class="convo-item" data-id="{{this.id}}">
            <div class="convo-avatar">
              <img src="{{this.avatar}}" alt="{{this.name}}">
            </div>
            <div class="convo-meta">
              <div class="name">{{this.name}}</div>
              <div class="last">{{this.last}}</div>
            </div>
          </div>
        {{/each}}
      </div>
    </aside>

    <section class="thread-col">
      <div class="thread-top">
        <button id="makeOfferBtn" class="make-offer-btn">
          {{#if isProvider}}Check Offer{{else}}Make Offer{{/if}}
        </button>
      </div>

      <div id="messagesArea" class="messages-area">
        {{#if activeConvo}}
          {{#each activeConvo.messages}}
            <div class="msg-row {{#if (eq this.from 'me')}}msg-me{{else}}msg-them{{/if}}">
              <div class="msg-bubble">{{this.text}}</div>
            </div>
          {{/each}}
        {{else}}
          <div class="placeholder">Select a conversation to start</div>
        {{/if}}
      </div>

        <!-- composer: attach, preview, input, send -->
      <div class="composer">
        <label class="attach-label" title="Attach image">
          <input type="file" id="attachFile" accept="image/*" multiple hidden>
          <i class="fa-solid fa-image attach-icon"></i>
        </label>

        <!-- preview container (messages.js will create it if not present, but having it here is safer) -->
        <div id="imagePreview" class="image-preview" aria-live="polite"></div>

        <input id="messageInput" class="message-input" placeholder="Type message here..." autocomplete="off">

        <button id="sendBtn" class="send-btn">Send</button>
      </div>
    </section>
  </main>


  <!-- Offer Modal -->
  <div id="offerModal" class="modal" aria-hidden="true">
    <div class="modal-inner" role="dialog" aria-modal="true" aria-labelledby="offerTitle">
      <header class="modal-header">
        <h3 id="offerTitle">
          {{#if isProvider}}Check Offer{{else}}Make Offer{{/if}}
        </h3>
        <button id="closeOffer" class="modal-close" aria-label="Close">✕</button>
      </header>

      <form id="offerForm" class="offer-form">

        {{#if isProvider}}
          <!-- Provider view -->
          <label style="display:block; margin-bottom:6px;">
            Price
            <div id="offerPriceDisplay"
                class="offer-price-display"
                role="status"
                aria-live="polite"
                data-value="0"
                style="font-size:20px; font-weight:700; margin-top:6px;">
              ₱0.00
            </div>
          </label>

          <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
            <button type="button" id="offerDecline" class="btn-secondary">Decline</button>
            <button type="submit" id="offerAccept" class="btn-primary">Accept</button>
          </div>

        {{else}}
          <!-- Customer view -->
          <label>
            Price
            <input id="offerPrice" name="price" type="number" min="0" step="0.01" placeholder="0.00" required />
          </label>

          <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
            <button type="button" id="offerNew" class="btn-secondary">Make New Offer</button>
            <button type="submit" id="offerSend" class="btn-primary">Send Offer</button>
          </div>
        {{/if}}
      </form>
    </div>
  </div>
</body>
</html>